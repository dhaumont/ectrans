SUBROUTINE INV_TRANS_FIELD_API(YD_FIELDS_PSP_2D,YD_FIELDS_PSP_3D,YD_FIELDS_PSP_4D, &
                              &YD_FIELDS_PGP_2D,YD_FIELDS_PGP_3D,YD_FIELDS_PGP_4D,&
                              &KVSETSC, &
                              &FSPGL_PROC, LDSCDERS,  LDVORGP,  LDDIVGP, &
                              &LDUVDER,   LDLATLON,  KPROMA,KRESOL,      &
                              &LACC)

                                      
    
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE FIELD_ACCESS_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_MODULE
USE FIELD_API_INTERFACE

USE YOMHOOK           ,ONLY : LHOOK,   DR_HOOK, JPHOOK

IMPLICIT NONE

TYPE (FIELDS_PSP_2D), OPTIONAL, INTENT(IN) :: YD_FIELDS_PSP_2D
TYPE (FIELDS_PSP_3D), OPTIONAL, INTENT(IN) :: YD_FIELDS_PSP_3D
TYPE (FIELDS_PSP_4D), OPTIONAL, INTENT(IN) :: YD_FIELDS_PSP_4D

TYPE (FIELDS_PGP_2D), OPTIONAL, INTENT(OUT) :: YD_FIELDS_PGP_2D
TYPE (FIELDS_PGP_3D), OPTIONAL, INTENT(OUT) :: YD_FIELDS_PGP_3D
TYPE (FIELDS_PGP_4D), OPTIONAL, INTENT(OUT) :: YD_FIELDS_PGP_4D

INTEGER(KIND=JPIM),   INTENT(IN) :: KVSETSC

LOGICAL   ,OPTIONAL, INTENT(IN) :: LDSCDERS
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDVORGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDDIVGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDUVDER
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDLATLON

INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KRESOL
EXTERNAL  FSPGL_PROC
OPTIONAL  FSPGL_PROC
INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KPROMA


LOGICAL, INTENT(IN), OPTIONAL :: LACC


! LOCAL VARIABLES
! TEMPORARY ARRAYS

REAL(KIND=JPRB), ALLOCATABLE :: PSPVOR(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPDIV(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC3(:,:,:) ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC2(:,:)    ! INPUT FIELD

REAL(KIND=JPRB), ALLOCATABLE :: PGPUV(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP3(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP2(:,:,:)    ! OUTPUT FIELD


!TEMPORARY DATA POINTERS
REAL(KIND=JPRB), POINTER  :: PTR_2D(:,:)
REAL(KIND=JPRB), POINTER  :: PTR_3D(:,:,:)
REAL(KIND=JPRB), POINTER  :: PTR_4D(:,:,:,:)


INTEGER(KIND=JPIM) :: JFLD

REAL(KIND=JPHOOK), POINTER, CONTIGUOUS :: ZHOOK_HANDLE
#include "inv_trans.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',0,ZHOOK_HANDLE)

  IF (PRESENT(YD_FIELDS_PSP_2D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PSP_2D%PSP_VOR)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PSP_2D%PSP_VOR)
        if (LACC) THEN
          PTR_2D => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP_2D%PSP_VOR(JFLD)%PTR)
        ELSE
          PTR_2D => GET_HOST_DATA_RDWR (YD_FIELDS_PSP_2D%PSP_VOR(JFLD)%PTR)
        ENDIF
        ! TODO COPY PTR_2D into PSPVOR
        ! PSPVOR(:,KLEV,KFLD, :) = PTR_2D(:,:)
      END DO
    END IF
  ENDIF

  IF (PRESENT(YD_FIELDS_PSP_3D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PSP_3D%PSP_VOR)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PSP_3D%PSP_VOR)
        if (LACC) THEN
          PTR_3D => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP_3D%PSP_VOR(JFLD)%PTR)
        ELSE
          PTR_3D => GET_HOST_DATA_RDWR (YD_FIELDS_PSP_3D%PSP_VOR(JFLD)%PTR)
        ENDIF
        ! TODO COPY PTR_3D into PSPVOR
        ! PSPVOR(:,:,KFLD,:) = PTR_3D(:,:,:)
      END DO
    END IF
  ENDIF

IF (PRESENT(YD_FIELDS_PSP_4D)) THEN    
  IF (ALLOCATED(YD_FIELDS_PSP_4D%PSP_VOR)) THEN
    DO JFLD = 1, SIZE(YD_FIELDS_PSP_4D%PSP_VOR)
      if (LACC) THEN
        PTR_4D => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP_4D%PSP_VOR(JFLD)%PTR)
      ELSE      
        PTR_4D => GET_HOST_DATA_RDWR (YD_FIELDS_PSP_4D%PSP_VOR(JFLD)%PTR)
      ENDIF

      ! TODO COPY PTR_4D into PSPVOR
      ! PSPVOR(:,:,KFLD,:) = PTR_4D(:,:,:,:)
    END DO
  END IF
ENDIF


CALL INV_TRANS(PSPVOR=PSPVOR,  PSPDIV=PSPDIV,      & !IN
              &PSPSC3A=PSPSC3, PSPSC2=PSPSC2,      & !IN
              &PGPUV=PGPUV,   PGP3A=PGP3, PGP2=PGP2) !OUT

if (LACC) THEN
                                                
  IF (PRESENT(YD_FIELDS_PGP_2D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PGP_2D%PGP_U)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PGP_2D%PGP_U)
        if (LACC) THEN
          PTR_2D => GET_DEVICE_DATA_RDWR (YD_FIELDS_PGP_2D%PGP_U(JFLD)%PTR)
        ELSE
          PTR_2D => GET_HOST_DATA_RDWR (YD_FIELDS_PGP_2D%PGP_U(JFLD)%PTR)
        ENDIF
        ! TODO COPY PGPUV into PTR_2D
        ! PTR_2D(:,:) = PGPUV(:,KLEV, KFLD, :)
      END DO
    END IF
  ENDIF
  IF (PRESENT(YD_FIELDS_PGP_3D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PGP_3D%PGP_U)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PGP_3D%PGP_U)
        if (LACC) THEN
          PTR_3D => GET_DEVICE_DATA_RDWR (YD_FIELDS_PGP_3D%PGP_U(JFLD)%PTR)
        ELSE
          PTR_3D => GET_HOST_DATA_RDWR (YD_FIELDS_PGP_3D%PGP_U(JFLD)%PTR)
        ENDIF
        ! TODO COPY PGPUV into PTR_3D
        ! PTR_3D(:,:,:) = PGPUV(:,:,KFIELD, :)
      END DO
    END IF
  ENDIF
  IF (PRESENT(YD_FIELDS_PGP_4D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PGP_4D%PGP_U)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PGP_4D%PGP_U)
        if (LACC) THEN
          PTR_4D => GET_DEVICE_DATA_RDWR (YD_FIELDS_PGP_4D%PGP_U(JFLD)%PTR)
        ELSE
          PTR_4D => GET_HOST_DATA_RDWR (YD_FIELDS_PGP_4D%PGP_U(JFLD)%PTR)
        ENDIF
        ! TODO COPY PGPUV into PTR_4D
        ! PTR_4D(:,:,:,:) = PGPUV(:,:, :, :)
      END DO
    END IF
  ENDIF
ENDIF

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',1,ZHOOK_HANDLE)
!     ------------------------------------------------------------------

END SUBROUTINE INV_TRANS_FIELD_API
SUBROUTINE INV_TRANS_FIELD_API(YD_FIELDS_PSP_2D,YD_FIELDS_PSP_3D,YD_FIELDS_PSP_4D, &
                              &YD_FIELDS_PGP_2D,YD_FIELDS_PGP_3D,YD_FIELDS_PGP_4D,&
                              &KVSETSC, &
                              &FSPGL_PROC, LDSCDERS,  LDVORGP,  LDDIVGP, &
                              &LDUVDER,   LDLATLON,  KPROMA,KRESOL,      &
                              &LACC)

                                      
    
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE FIELD_ACCESS_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_MODULE
USE FIELD_API_INTERFACE

USE YOMHOOK           ,ONLY : LHOOK,   DR_HOOK, JPHOOK

IMPLICIT NONE

TYPE (FIELDS_PSP_2D), OPTIONAL, INTENT(IN) :: YD_FIELDS_PSP_2D
TYPE (FIELDS_PSP_2D), OPTIONAL, INTENT(IN) :: YD_FIELDS_PSP_3D
TYPE (FIELDS_PSP_2D), OPTIONAL, INTENT(IN) :: YD_FIELDS_PSP_4D

TYPE (FIELDS_PGP_2D), OPTIONAL, INTENT(OUT) :: YD_FIELDS_PGP_2D
TYPE (FIELDS_PGP_3D), OPTIONAL, INTENT(OUT) :: YD_FIELDS_PGP_3D
TYPE (FIELDS_PGP_4D), OPTIONAL, INTENT(OUT) :: YD_FIELDS_PGP_4D

INTEGER(KIND=JPIM),   INTENT(IN) :: KVSETSC

LOGICAL   ,OPTIONAL, INTENT(IN) :: LDSCDERS
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDVORGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDDIVGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDUVDER
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDLATLON

INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KRESOL
EXTERNAL  FSPGL_PROC
OPTIONAL  FSPGL_PROC
INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KPROMA


LOGICAL, INTENT(IN), OPTIONAL :: LACC


! LOCAL VARIABLES
! TEMPORARY ARRAYS

REAL(KIND=JPRB), ALLOCATABLE :: PSPVOR(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPDIV(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC3(:,:,:) ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC2(:,:)    ! INPUT FIELD

REAL(KIND=JPRB), ALLOCATABLE :: PGPUV(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP3(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP2(:,:,:)    ! OUTPUT FIELD


!TEMPORARY DATA POINTERS
REAL(KIND=JPRB), POINTER  :: PTR_2D(:,:)
REAL(KIND=JPRB), POINTER  :: PTR_3D(:,:,:)
REAL(KIND=JPRB), POINTER  :: PTR_4D(:,:,:,:)


INTEGER(KIND=JPIM) :: JFLD

REAL(KIND=JPHOOK), POINTER, CONTIGUOUS :: ZHOOK_HANDLE
#include "inv_trans.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',0,ZHOOK_HANDLE)


if (LACC) THEN
  IF (PRESENT(YD_FIELDS_PSP_2D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PSP_2D%PSP_VOR)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PSP_2D%PSP_VOR)
        PTR_2D => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP_2D%PSP_VOR(JFLD)%PTR)
        ! TODO COPY PTR_2D into PSPVOR
        ! PSPVOR(:,KFLD, KLEV,:) = PTR_2D(:,:)
      END DO
    END IF
  ENDIF
ENDIF

CALL INV_TRANS(PSPVOR=PSPVOR,  PSPDIV=PSPDIV,      & !IN
              &PSPSC3A=PSPSC3, PSPSC2=PSPSC2,      & !IN
              &PGPUV=PGPUV,   PGP3A=PGP3, PGP2=PGP2) !OUT

if (LACC) THEN
                                                
  IF (PRESENT(YD_FIELDS_PGP_2D)) THEN    
    IF (ALLOCATED(YD_FIELDS_PGP_2D%PGP_U)) THEN
      DO JFLD = 1, SIZE(YD_FIELDS_PGP_2D%PGP_U)
        PTR_2D => GET_DEVICE_DATA_RDWR (YD_FIELDS_PGP_2D%PGP_U(JFLD)%PTR)
        ! TODO COPY PGPUV into PTR_2D
        ! PTR_2D(:,:) = PGPUV(:,KFLD, KLEV, )
      END DO
    END IF
  ENDIF
ENDIF

IF (LHOOK) CALL DR_HOOK('INV_TRANS',1,ZHOOK_HANDLE)
!     ------------------------------------------------------------------

END SUBROUTINE INV_TRANS_FIELD_API
SUBROUTINE INV_TRANS_FIELD_API(YD_FIELDS_PSP, YD_FIELDS_PGP, KVSETSC, &
                              &FSPGL_PROC, LDSCDERS,  LDVORGP,  LDDIVGP, &
                              &LDUVDER,   LDLATLON,  KPROMA,KRESOL,      &
                              &LACC)

                                      
    
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE FIELD_ACCESS_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_MODULE
USE FIELD_API_INTERFACE

USE YOMHOOK           ,ONLY : LHOOK,   DR_HOOK, JPHOOK

IMPLICIT NONE

TYPE (FIELDS_PSP), INTENT(IN) :: YD_FIELDS_PSP
TYPE (FIELDS_PGP), INTENT(OUT) :: YD_FIELDS_PGP
TYPE (FIELDS_KVSETC), INTENT(IN) :: KVSETSC

LOGICAL   ,OPTIONAL, INTENT(IN) :: LDSCDERS
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDVORGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDDIVGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDUVDER
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDLATLON

INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KRESOL
EXTERNAL  FSPGL_PROC
OPTIONAL  FSPGL_PROC
INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KPROMA


LOGICAL, INTENT(IN), OPTIONAL :: LACC


! LOCAL VARIABLES

!TEMPORARY INPUT
REAL(KIND=JPRB), POINTER  :: PSPVOR(:,:)
REAL(KIND=JPRB), POINTER  :: PSPDIV(:,:)
REAL(KIND=JPRB), POINTER  :: PSPSCALAR(:,:)
REAL(KIND=JPRB), POINTER  :: PSPSC_3D(:,:,:)
REAL(KIND=JPRB), POINTER  :: PSPSC_2D(:,:)

!TEMPORARY OUTPUT
REAL(KIND=JPRB),POINTER :: PGP(:,:,:)
REAL(KIND=JPRB),POINTER :: PGPUV(:,:,:,:)
REAL(KIND=JPRB),POINTER :: PGP_3D(:,:,:,:)
REAL(KIND=JPRB),POINTER :: PGP_2D(:,:,:)

REAL(KIND=JPHOOK), POINTER, CONTIGUOUS :: ZHOOK_HANDLE
#include "inv_trans.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',0,ZHOOK_HANDLE)

PSPVOR => NULL ()
PSPDIV => NULL ()
PSPSCALAR => NULL ()
PSPSC_3D => NULL ()
PSPSC_2D => NULL ()

if (LACC) THEN
  IF (ASSOCIATED(YD_FIELDS_PSP%F_PSPVOR)) PSPVOR => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP%F_PSPVOR)
  IF (ASSOCIATED(YD_FIELDS_PSP%F_PSPDIV)) PSPVOR => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP%F_PSPDIV)
  !IF (ASSOCIATED(YD_FIELDS_PSP%F_PSPSCALAR)) PSPVOR => GET_DEVICE_DATA_RDONLY (YD_FIELDS_PSP%F_PSPSCALAR)
  
  !ALLOCATE(PSPSC_3D(NPROMA,NLEVS,NUM_3D_FIELDS, NGPBLKS))
  !ALLOCATE(PSPSC_2D(NPROMA,NUM_3D_FIELDS, NGPBLKS))
  
  !ALLOCATE(PSPSC_3D(NPROMA,NLEVS,NUM_3D_FIELDS, NGPBLKS))
  !ALLOCATE(PSPSC_2D(NPROMA,NUM_3D_FIELDS, NGPBLKS))
  
ELSE
  IF (ASSOCIATED(YD_FIELDS_PSP%F_PSPVOR)) PSPVOR => GET_HOST_DATA_RDONLY (YD_FIELDS_PSP%F_PSPVOR)
  IF (ASSOCIATED(YD_FIELDS_PSP%F_PSPDIV)) PSPDIV => GET_HOST_DATA_RDONLY (YD_FIELDS_PSP%F_PSPDIV)
  !IF (ASSOCIATED(YD_FIELDS_PSP%F_PSPSCALAR)) PSPSCALAR => GET_HOST_DATA_RDONLY (YD_FIELDS_PSP%F_PSPSCALAR)
  
  !IF (ASSOCIATED(YD_FIELDS_PGP%F_U)) PSPVOR => GET_HOST_DATA_RDWR (YD_FIELDS_PGP%F_U)
  !IF (ASSOCIATED(YD_FIELDS_PGP%F_V)) PSPVOR => GET_HOST_DATA_RDWR (YD_FIELDS_PGP%F_V)
  !IF(PRESENT(YD_PGP)) PGP => GET_DEVICE_DATA_RDWR (YD_PGP)
  !IF(PRESENT(YD_PGPUV)) PGPUV => GET_DEVICE_DATA_RDWR (YD_PGPUV)
  
ENDIF

!CALL INV_TRANS(PSPVOR=PSPVOR,       PSPDIV=PSPDIV,                       &
 !             &PSPSCALAR=PSPSCALAR, PSPSC3A=PSPSC_3D,                    &
  !            &PSPSC2=PSPSC_2D,     FSPGL_PROC=FSPGL_PROC,               &
   !           &LDSCDERS=LDSCDERS,   LDVORGP=LDVORGP,                     &
    !          &LDDIVGP=LDDIVGP,     LDUVDER=LDUVDER,                     &
     !         &LDLATLON=LDLATLON,   KPROMA=KPROMA,                       &
      !        &KVSETUV=KVSETUV,     KVSETSC=KVSETSC,                     &
       !       &KRESOL=KRESOL,       KVSETSC3A=KVSETSC_3D,                &
        !      &KVSETSC2=KVSETSC_2D, PGP=PGP,                             &
         !     &PGPUV=PGPUV,         PGP3A=PGP_3D,                        &
          !    &PGP2=PGP_2D)                                               

                                                 

DEALLOCATE(PSPSC_2D)
DEALLOCATE(PSPSC_3D)
                      

IF (LHOOK) CALL DR_HOOK('INV_TRANS',1,ZHOOK_HANDLE)
!     ------------------------------------------------------------------

END SUBROUTINE INV_TRANS_FIELD_API
SUBROUTINE INV_TRANS_FIELD_API(YD_SPECTRAL_S2D,YD_SPECTRAL_S3D,YD_SPECTRAL_S4D, &
                              &YD_SPECTRAL_V2D,YD_SPECTRAL_V3D,YD_SPECTRAL_V4D,&
                              &KVSETSC, &
                              &FSPGL_PROC, LDSCDERS,  LDVORGP,  LDDIVGP, &
                              &LDUVDER,   LDLATLON,  KPROMA,KRESOL,      &
                              &LACC)

                                      
    
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE FIELD_ACCESS_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_MODULE
USE FIELD_API_INTERFACE

USE YOMHOOK           ,ONLY : LHOOK,   DR_HOOK, JPHOOK

IMPLICIT NONE

TYPE (SPECTRAL_S2D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_S2D(:)
TYPE (SPECTRAL_S3D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_S3D(:)
TYPE (SPECTRAL_S4D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_S4D(:)

TYPE (SPECTRAL_V2D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_V2D(:)
TYPE (SPECTRAL_V3D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_V3D(:)
TYPE (SPECTRAL_V4D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_V4D(:)

INTEGER(KIND=JPIM),   INTENT(IN) :: KVSETSC

LOGICAL   ,OPTIONAL, INTENT(IN) :: LDSCDERS
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDVORGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDDIVGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDUVDER
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDLATLON

INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KRESOL
EXTERNAL  FSPGL_PROC
OPTIONAL  FSPGL_PROC
INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KPROMA


LOGICAL, INTENT(IN), OPTIONAL :: LACC


! LOCAL VARIABLES
! TEMPORARY ARRAYS

REAL(KIND=JPRB), ALLOCATABLE :: PSPVOR(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPDIV(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC3(:,:,:) ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC2(:,:)    ! INPUT FIELD

REAL(KIND=JPRB), ALLOCATABLE :: PGPUV(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP3(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP2(:,:,:)    ! OUTPUT FIELD


!TEMPORARY DATA POINTERS
REAL(KIND=JPRB), POINTER  :: PTR_2D(:,:)
REAL(KIND=JPRB), POINTER  :: PTR_3D(:,:,:)
REAL(KIND=JPRB), POINTER  :: PTR_4D(:,:,:,:)


INTEGER(KIND=JPIM) :: JFLD


REAL(KIND=JPHOOK), POINTER, CONTIGUOUS :: ZHOOK_HANDLE
#include "inv_trans.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',0,ZHOOK_HANDLE)

IF (PRESENT(YD_SPECTRAL_V2D)) THEN    
    DO JFLD = 1, SIZE(YD_SPECTRAL_V2D)
      IF (ASSOCIATED(YD_SPECTRAL_V2D(JFLD)%PSP_VOR)) THEN        
        IF (LACC) THEN
          PTR_2D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V2D(JFLD)%PSP_VOR)
        ELSE
          PTR_2D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V2D(JFLD)%PSP_VOR)
        END IF
          !TODO YD_SPECTRAL_V2D(JFLD)%LEV = ... + 1
          !TODO YD_SPECTRAL_V2D(JFLD)%FLD = ... + 1
          !PSPVOR(:,YD_SPECTRAL_V2D(JFLD)%LEV,YD_SPECTRAL_V2D(JFLD)%FLD, :) = PTR_2D(:,:)
      END IF
    END DO
  END IF


IF (PRESENT(YD_SPECTRAL_V3D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V3D)
    IF (ASSOCIATED(YD_SPECTRAL_V3D(JFLD)%PSP_VOR)) THEN        
      IF (LACC) THEN
        PTR_3D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V3D(JFLD)%PSP_VOR)
      ELSE
        PTR_3D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V3D(JFLD)%PSP_VOR)
      END IF
        !TODO YD_SPECTRAL_V3D(JFLD)%LEV = ... + 1
        !TODO YD_SPECTRAL_V3D(JFLD)%FLD = ... + 1
          
       !   PSPVOR(:,:,YD_SPECTRAL_V2D(JFLD)%FLD,:) = PTR_3D(:,:,:)
    END IF
  END DO
END IF


IF (PRESENT(YD_SPECTRAL_V4D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V4D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PSP_VOR)) THEN        
      IF (LACC) THEN
        PTR_4D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V4D(JFLD)%PSP_VOR)
      ELSE
        PTR_4D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V4D(JFLD)%PSP_VOR)
      END IF
    
      !TODO YD_SPECTRAL_V4D(JFLD)%LEV = ... + 1
      !TODO YD_SPECTRAL_V4D(JFLD)%FLD = ...
    
     !  PSPVOR(:,:,:,:) = PTR_4D(:,:,:,:)
    END IF
  END DO
END IF

CALL INV_TRANS(PSPVOR=PSPVOR,  PSPDIV=PSPDIV,      & !IN
              &PSPSC3A=PSPSC3, PSPSC2=PSPSC2,      & !IN
              &PGPUV=PGPUV,   PGP3A=PGP3, PGP2=PGP2) !OUT
                                  
IF (PRESENT(YD_SPECTRAL_V2D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V2D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PGP_U)) THEN        

      IF (LACC) THEN
        PTR_2D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V2D(JFLD)%PGP_U)
      ELSE
        PTR_2D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V2D(JFLD)%PGP_U)
      END IF
        
        PTR_2D(:,:) = PGPUV(:,YD_SPECTRAL_V2D(JFLD)%LEV, YD_SPECTRAL_V2D(JFLD)%FLD, :)
    END IF
  END DO
END IF
                                                
IF (PRESENT(YD_SPECTRAL_V3D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V3D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PGP_U)) THEN        
      IF (LACC) THEN
        PTR_3D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V3D(JFLD)%PGP_U)
      ELSE
        PTR_3D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V3D(JFLD)%PGP_U)
      END IF
        
        PTR_3D(:,:,:) = PGPUV(:,:,YD_SPECTRAL_V3D(JFLD)%FLD, :)
    END IF
  END DO    
END IF
                                              
IF (PRESENT(YD_SPECTRAL_V4D)) THEN 
  DO JFLD = 1, SIZE(YD_SPECTRAL_V4D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PGP_U)) THEN        
      IF (LACC) THEN
        PTR_4D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V4D(JFLD)%PGP_U)
      ELSE
        PTR_4D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V4D(JFLD)%PGP_U)
      END IF
      
       PTR_4D(:,:,:,:) = PGPUV(:,:, :, :)
    END IF
  END DO
END IF

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',1,ZHOOK_HANDLE)
!     ------------------------------------------------------------------

END SUBROUTINE INV_TRANS_FIELD_API
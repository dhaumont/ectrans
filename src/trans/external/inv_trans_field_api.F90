SUBROUTINE INV_TRANS_FIELD_API(YD_SPECTRAL_S2D,YD_SPECTRAL_S3D,YD_SPECTRAL_S4D, &
                              &YD_SPECTRAL_V2D,YD_SPECTRAL_V3D,YD_SPECTRAL_V4D,&
                              &KVSETSC, &
                              &FSPGL_PROC, LDSCDERS,  LDVORGP,  LDDIVGP, &
                              &LDUVDER,   LDLATLON,  KPROMA,KRESOL,      &
                              &LACC)

                                      
    
USE PARKIND1  ,ONLY : JPIM     ,JPRB
USE FIELD_ACCESS_MODULE
USE FIELD_FACTORY_MODULE
USE FIELD_MODULE
USE FIELD_API_INTERFACE

USE YOMHOOK           ,ONLY : LHOOK,   DR_HOOK, JPHOOK

IMPLICIT NONE

TYPE (SPECTRAL_S2D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_S2D(:)
TYPE (SPECTRAL_S3D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_S3D(:)
TYPE (SPECTRAL_S4D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_S4D(:)

TYPE (SPECTRAL_V2D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_V2D(:)
TYPE (SPECTRAL_V3D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_V3D(:)
TYPE (SPECTRAL_V4D), OPTIONAL, INTENT(INOUT) :: YD_SPECTRAL_V4D(:)

INTEGER(KIND=JPIM),   INTENT(IN) :: KVSETSC

LOGICAL   ,OPTIONAL, INTENT(IN) :: LDSCDERS
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDVORGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDDIVGP
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDUVDER
LOGICAL   ,OPTIONAL, INTENT(IN) :: LDLATLON

INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KRESOL
EXTERNAL  FSPGL_PROC
OPTIONAL  FSPGL_PROC
INTEGER(KIND=JPIM) ,OPTIONAL, INTENT(IN) :: KPROMA


LOGICAL, INTENT(IN), OPTIONAL :: LACC


! LOCAL VARIABLES
! TEMPORARY ARRAYS

REAL(KIND=JPRB), ALLOCATABLE :: PSPVOR(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPDIV(:,:)   ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC3(:,:,:) ! INPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PSPSC2(:,:)    ! INPUT FIELD

REAL(KIND=JPRB), ALLOCATABLE :: PGPUV(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP3(:,:,:,:) ! OUTPUT FIELD
REAL(KIND=JPRB), ALLOCATABLE :: PGP2(:,:,:)    ! OUTPUT FIELD


!TEMPORARY DATA POINTERS
REAL(KIND=JPRB), POINTER  :: PTR_2D(:,:)
REAL(KIND=JPRB), POINTER  :: PTR_3D(:,:,:)
REAL(KIND=JPRB), POINTER  :: PTR_4D(:,:,:,:)


INTEGER(KIND=JPIM) :: JFLD, V_IDX, S_IDX, JFLD1, JLEV1, NFIELDS, NLEVS


REAL(KIND=JPHOOK), POINTER, CONTIGUOUS :: ZHOOK_HANDLE
#include "inv_trans.h"

!     ------------------------------------------------------------------

IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',0,ZHOOK_HANDLE)

V_IDX = 1
S_IDX = 1

! Step 1: Assign index to each field
IF (PRESENT(YD_SPECTRAL_V2D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V2D)
    IF (ASSOCIATED(YD_SPECTRAL_V2D(JFLD)%PSP_VOR)) THEN        
      YD_SPECTRAL_V2D(JFLD)%IDX = V_IDX
      V_IDX = V_IDX + 1      
    END IF
  END DO
END IF

IF (PRESENT(YD_SPECTRAL_V3D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V3D)
    IF (ASSOCIATED(YD_SPECTRAL_V3D(JFLD)%PSP_VOR)) THEN
      YD_SPECTRAL_V2D(JFLD)%IDX = V_IDX
      NFIELDS = SIZE(PTR_3D, 2)      
      V_IDX = V_IDX + NFIELDS    
    END IF
  END DO
END IF

IF (PRESENT(YD_SPECTRAL_V4D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V4D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PSP_VOR)) THEN
      YD_SPECTRAL_V2D(JFLD)%IDX = V_IDX    
      NFIELDS = SIZE(PTR_3D, 3)
      NLEVS = SIZE(PTR_3D, 2)
      V_IDX = V_IDX + NFIELDS*NLEVS    
    END IF
  END DO
END IF

! Step 2: Allocate temporary arrays
!ALLOCATE(PSPVOR(V_IDX, SIZE))
!ALLOCATE(PSPDIV(V_IDX, SIZE))
!ALLOCATE(PSPSC3(V_IDX, SIZE))
!ALLOCATE(PSPSC2(V_IDX, SIZE))
!ALLOCATE(PGPUV(V_IDX, SIZE))
!ALLOCATE(PGP3(V_IDX, SIZE))
!ALLOCATE(PGP2(V_IDX, SIZE))

IF (LACC) THEN
  ! Allocate the temporary arrays in device memory
ENDIF

! Step 3: Copy fields to temporary arrays
IF (PRESENT(YD_SPECTRAL_V2D)) THEN    
    DO JFLD = 1, SIZE(YD_SPECTRAL_V2D)
      IF (ASSOCIATED(YD_SPECTRAL_V2D(JFLD)%PSP_VOR)) THEN        
        IF (LACC) THEN
          PTR_2D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V2D(JFLD)%PSP_VOR)
        ELSE
          PTR_2D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V2D(JFLD)%PSP_VOR)
        END IF
        V_IDX = YD_SPECTRAL_V2D(JFLD)%IDX
        
    !    PSPVOR(V_IDX, :) = PTR_2D(:,:)
      
      END IF
    END DO
  END IF


IF (PRESENT(YD_SPECTRAL_V3D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V3D)
    IF (ASSOCIATED(YD_SPECTRAL_V3D(JFLD)%PSP_VOR)) THEN        
      IF (LACC) THEN
        PTR_3D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V3D(JFLD)%PSP_VOR)
      ELSE
        PTR_3D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V3D(JFLD)%PSP_VOR)
      END IF

      V_IDX = YD_SPECTRAL_V2D(JFLD)%IDX
      NFIELDS = SIZE(PTR_3D, 2)      
      
      DO JFLD1 = 1,NFIELDS
        !PSPVOR(V_IDX,:) = PTR_3D(:,:,JFLD1)
        V_IDX = V_IDX + 1
      END DO
    END IF
  END DO
END IF


IF (PRESENT(YD_SPECTRAL_V4D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V4D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PSP_VOR)) THEN        
      IF (LACC) THEN
        PTR_4D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V4D(JFLD)%PSP_VOR)
      ELSE
        PTR_4D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V4D(JFLD)%PSP_VOR)
      END IF

      V_IDX = YD_SPECTRAL_V2D(JFLD)%IDX
    
      NFIELDS = SIZE(PTR_3D, 3)
      NLEVS = SIZE(PTR_3D, 2)

      DO JFLD1 = 1,NFIELDS
        DO JLEV1 = 1,NLEVS
       !   PSPVOR(V_IDX,:) = PTR_4D(:,:,JLEV1,JFLD1)
          V_IDX = V_IDX + 1
        END DO
      ENDDO
     
    END IF
  END DO
END IF

! Step 4 : Call the inverse transformation routine

CALL INV_TRANS(PSPVOR=PSPVOR,  PSPDIV=PSPDIV,      & !IN
              &PSPSC3A=PSPSC3, PSPSC2=PSPSC2,      & !IN
              &PGPUV=PGPUV,   PGP3A=PGP3, PGP2=PGP2) !OUT
            
! Step 4 : Copy from temporary arrays to fields

IF (PRESENT(YD_SPECTRAL_V2D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V2D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PGP_U)) THEN        

      IF (LACC) THEN
        PTR_2D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V2D(JFLD)%PGP_U)
      ELSE
        PTR_2D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V2D(JFLD)%PGP_U)
      END IF
      V_IDX = YD_SPECTRAL_V2D(JFLD)%IDX 
     ! PTR_2D(:,:) = PGPUV(:, 1 ,V+IDX, :)
    END IF
  END DO
END IF
                                                
IF (PRESENT(YD_SPECTRAL_V3D)) THEN    
  DO JFLD = 1, SIZE(YD_SPECTRAL_V3D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PGP_U)) THEN        
      IF (LACC) THEN
        PTR_3D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V3D(JFLD)%PGP_U)
      ELSE
        PTR_3D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V3D(JFLD)%PGP_U)
      END IF
    V_IDX = YD_SPECTRAL_V3D(JFLD)%IDX 

    DO JFLD1 = 1,NFIELDS
    !PTR_3D(:,:,:) = PGPUV(:,1,V_IDX,:)
      V_IDX = V_IDX + 1
    END DO
        
    END IF
  END DO    
END IF
                                              
IF (PRESENT(YD_SPECTRAL_V4D)) THEN 
  DO JFLD = 1, SIZE(YD_SPECTRAL_V4D)
    IF (ASSOCIATED(YD_SPECTRAL_V4D(JFLD)%PGP_U)) THEN        
      IF (LACC) THEN
        PTR_4D => GET_DEVICE_DATA_RDONLY (YD_SPECTRAL_V4D(JFLD)%PGP_U)
      ELSE
        PTR_4D => GET_HOST_DATA_RDWR (YD_SPECTRAL_V4D(JFLD)%PGP_U)
      END IF
      NFIELDS = SIZE(PTR_3D, 3)
      NLEVS = SIZE(PTR_3D, 2)
      V_IDX = YD_SPECTRAL_V4D(JFLD)%IDX 
      DO JFLD1 = 1,NFIELDS
        DO JLEV1 = 1,NLEVS
        !  PTR_4D(:,:,:,:) = PGPUV(:,JLEV1, V_IDX, :)          
        END DO
        V_IDX = V_IDX + 1
      ENDDO
     
     
    END IF
  END DO
END IF

! Step 5 Delete temporary arrays
!DEALLOCATE(PSPVOR)
!DEALLOCATE(PSPDIV)
!DEALLOCATE(PSPSC3)
!DEALLOCATE(PSPSC2)
!DEALLOCATE(PGPUV)
!DEALLOCATE(PGP3)
!DEALLOCATE(PGP2)


IF (LHOOK) CALL DR_HOOK('INV_TRANS_FIELD_API',1,ZHOOK_HANDLE)
!     ------------------------------------------------------------------

END SUBROUTINE INV_TRANS_FIELD_API